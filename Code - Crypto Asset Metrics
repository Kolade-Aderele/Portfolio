function onOpen() {

  // This function runs a few tasks when the google sheet is opened or refreshed.
  
  // Here is a link to the google sheet: https://docs.google.com/spreadsheets/d/1iyL45xPOm9tZeX9E873-LgUjHtE2ZCYZdu4A55FnZwU/edit#gid=0
  
  // Next few lines creates a menu of tasks:

  // first retrieved the user interface of the google sheet

  var ui = SpreadsheetApp.getUi();

  // Then create the menu
  
  ui.createMenu('Get Asset Data from Messari')
     
   // add items to the menu

   // add the callAsset Data function to the menu.    
      .addItem('Get Asset Data','callAssetData')
      .addToUi();

//displays a welcome message

  Browser.msgBox("Welcome Message and Instructions", "Welcome to the Crypto Assets Metrics Google Sheet. This sheet imports the historical price, trade volume and market capitalization data for the speicifed asset within the specified period. \\n \\n Here are a few instructions on how to operate the spreadsheet: \\n 1. Query the data by entering the inputs in the sections that have a Yellow background color and Blue font color. \\n 2. Click on 'Get Asset Data from Messari' and then 'Get Asset Data' to run the function that imports the required data for the speicified asset in the specified date range.\\n 3. Please do not alter, insert, delete or shift columns or data in the spreadsheet. Doing so would require altering the code in the backend of the spreadsheet. \\n 4. Click on 'Extensions' then 'Apps Script' to access the developer environment that stores the backend code.", Browser.Buttons.OK)

}



function callAssetData() {
  // This function retrieves the historical Price, Trade Volume and Market Cap time series data for an asset from a certain start date to the end date
  
  // In this function we are going to use the callAsset_Price, callAsset_Trade_Volume and the callAsset_Market_Cap functions.

  // Start with the callAsset_Price function to import the asset's Date, Open Price, High Price, Low Price and Close Price data into the spreadsheet.

  callAsset_Price()

  // Next use the callAsset_Trade_Volume function to import the asset's Trade Volume data into the spreadsheet.

  callAsset_Trade_Volume()

  // Next use the callAsset_Market_Capitalization function to import the asset's Market Capitalization data into the spreadsheet.

  callAsset_Market_Cap()

 // That is the end of the function.

}


function callAsset_Price() {
// This function retrieves the historical open, high, low and close price data for an asset for a specified period.

// First retrieve the spreadsheet (google sheet) we want to work on. The name of the google sheet is the Crypto Assets Metrics.  

// To do that we first get the active spreadsheet 

var app = SpreadsheetApp;

// Next we get the active google sheet " Crypto Asset Metrics" and stores it in a variable get_active_spreadsheet.

var get_active_spreadsheet = app.getActiveSpreadsheet();

// get the worksheet we will be working on. The name of the worksheet is "Model". Hence we will get the Model worksheet and store it in the variable get_model

var get_model = get_active_spreadsheet.getSheetByName("Model")

// Next we are going to clear the previous data in the range we are going to update

/* The next line clears the data in the range we are working with. The purpose is that before we source the data we are going to clear any data already existing in those rows. 
This particular line clears the data in the Open, High, Low, Close sections of the Model worksheet */

get_model.getRange(12,2,1500,5).clearContent()

// Next we are going to work on importing the Asset's price data by calling/ pulling the data from Messari's "Get Asset Timeseries API".

// First we are going to pull the appropriate input's from the input section of the data set. 

/* The data we need inputted from the Model worksheet is the Asset's Ticker, Start Date and End Date. We are going to import this data and store it in their individual/ respective variables. 
We are going to use those inputs to form the Messari's API. That is they are going to be used to call the data from the appropriate API. We need to verify that the datatype of the inputs we retrieve are Strings
Hence we are going to confirm the data type. If they are not Strings we are going to convert the data to Strings. */

// First we will start by retreiving the Asset's Ticker input and store it in the variable get_ticker

var get_ticker = get_model.getRange("C5").getValue();

// Next use the Logger.log function we are going to log the data type of the Asset Ticker.

// Logger.log(typeof get_ticker)

// Next we are going to get the Start Date input and store it in the variable get_start

var get_start = get_model.getRange("D5").getValue();

// Next use the Logger.log function we are going to log the data type of the Start Date.

// Logger.log(typeof get_start)

/// Next we are going to get the End Date input and store it in the variable get_end

var get_end = get_model.getRange("E5").getValue();

// Next use the Logger.log function we are going to log the data type of the End Date.

// Logger.log(typeof get_end)

// Next we are going to use the get_ticker, get_start and get_end variables to source the data from messari. We are going to store the pulled data in the variable data_source

var data_source = UrlFetchApp.fetch("https://data.messari.io/api/v1/assets/" + get_ticker +"/metrics/price/time-series?start=" + get_start + "&interval=1d&end=" + get_end);

// Next we are going to log the data source to check if the data we got was correct.

// Logger.log(" ")

// Logger.log(data_source)

// In the next two steps we are going to retrieve the content of the API then parse it into JSON which would allow us to work on the content of the API.

// First we retrieve the content of the API and store it in the variable data_source_content.

var data_source_content = data_source.getContentText();

// Next we parse the data and store the result in the variable data_source_result.

var data_source_result = JSON.parse(data_source_content);

// Since we want the data to display in descending order from End Date to Start Date we ae going to reverse the order of the result and store the data in the variable data_source_reverse_order

var data_source_reverse_order = data_source_result.data.values.reverse()

// The above function reverses the order of the values array. 

/* The next few steps we are going to start outputting the data in the respective positions on the Model worksheet. We are going to create a variable outer_looper to loop through the outer array.
That will allow us to get the line by line data. Next we are going to create Date, Open, High, Low and Close loops to get the respective data based on the index position in the inner array. 
The Date is the first in the array so the index position is 0, The Open index position is 1, High index position is 2, Low index position is 3 and Close index position is 4. 
For now we are going to ignore the volume which is the trade volume data which has an index position of 5.Also note that Date is currently store in the timestamp format and we are going to work on changing the format. */

// creating the outer_looper

var outer_looper = 0;

// Looping through the outer array
 
for (outer_looper = 0; outer_looper < data_source_reverse_order.length; outer_looper++) {

// Next we are going to create variables for Date, Open, High, Low and Close data points to get the respective values from the inner array.

// We are going to start with the date, create a variable date_looper.

var date_looper = 0

// Next we are going to output the variable in the respect position in the spreadsheet and change the format from timestamp to date.

if (date_looper === 0) get_model.getRange( outer_looper + 12 ,date_looper+2).setValue(new Date(data_source_reverse_order[outer_looper][date_looper]));


// Next we are going to output the Open price. We create a variable open_looper

var open_looper = 1

if(open_looper === 1) get_model.getRange(outer_looper + 12, open_looper + 2 ).setValue(data_source_reverse_order[outer_looper][open_looper])

// Next we are going to output the High price. We create a variable high_looper

var high_looper = 2

if(high_looper === 2) get_model.getRange(outer_looper + 12, high_looper + 2 ).setValue(data_source_reverse_order[outer_looper][high_looper])

// Next we are going to output the Low price. We create a variable low_looper

var low_looper = 3

if(low_looper === 3) get_model.getRange(outer_looper + 12, low_looper + 2 ).setValue(data_source_reverse_order[outer_looper][low_looper])



// Next we are going to output the Close price. We create a variable close_looper

var close_looper = 4

if(close_looper === 4) get_model.getRange(outer_looper + 12, close_looper + 2 ).setValue(data_source_reverse_order[outer_looper][close_looper])

}

// That is the end of this function. 

}



function callAsset_Trade_Volume() {
// This function retrieves the historical Trade Volume data for an asset for a specified period.

// First retrieve the spreadsheet (google sheet) we want to work on. The name of the google sheet is the Crypto Assets Metrics.  

// To do that we first get the active spreadsheet 

var app = SpreadsheetApp;

// Next we get the active google sheet " Crypto Asset Metrics" and stores it in a variable get_active_spreadsheet.

var get_active_spreadsheet = app.getActiveSpreadsheet();

// get the worksheet we will be working on. The name of the worksheet is "Model". Hence we will get the Model worksheet and store it in the variable get_model

var get_model = get_active_spreadsheet.getSheetByName("Model")

// Next we are going to clear the previous data in the range we are going to update

/* The next line clears the data in the range we are working with. The purpose is that before we source the data we are going to clear any data already existing in those rows. 
This particular line clears the data in the Open, High, Low, Close sections of the Model worksheet */

get_model.getRange(12,8,1500,1).clearContent()

// Next we are going to work on importing the Asset's trade volume data by calling/ pulling the data from Messari's "Get Asset Timeseries API".

// First we are going to pull the appropriate input's from the input section of the data set. 

/* The data we need inputted from the Model worksheet is the Asset's Ticker, Start Date and End Date. We are going to import this data and store it in their individual/ respective variables. 
We are going to use those inputs to form the Messari's API. That is they are going to be used to call the data from the appropriate API. We need to verify that the datatype of the inputs we retrieve are Strings
Hence we are going to confirm the data type. If they are not Strings we are going to convert the data to Strings. */

// First we will start by retreiving the Asset's Ticker input and store it in the variable get_ticker

var get_ticker = get_model.getRange("C5").getValue();

// Next use the Logger.log function we are going to log the data type of the Asset Ticker.

// Logger.log(typeof get_ticker)

// Next we are going to get the Start Date input and store it in the variable get_start

var get_start = get_model.getRange("D5").getValue();

// Next use the Logger.log function we are going to log the data type of the Start Date.

// Logger.log(typeof get_start)

/// Next we are going to get the End Date input and store it in the variable get_end

var get_end = get_model.getRange("E5").getValue();

// Next use the Logger.log function we are going to log the data type of the End Date.

// Logger.log(typeof get_end)

/* Next we are going to use the get_ticker, get_start and get_end variables to source the data from messari. We are going to store the pulled data in the variable data_source
Note we are using the real.vol API to assess the trade volume free of any wash trading. It is well known that many exchanges conduct wash trading practices in order to inflate 
trading volume. They are incentivized to report inflated volumes in order to attract traders.*/


var data_source = UrlFetchApp.fetch("https://data.messari.io/api/v1/assets/" + get_ticker +"/metrics/real.vol/time-series?start=" + get_start + "&interval=1d&end=" + get_end);

// Next we are going to log the data source to check if the data we got was correct.

// Logger.log(" ")

// Logger.log(data_source)

// In the next two steps we are going to retrieve the content of the API then parse it into JSON which would allow us to work on the content of the API.

// First we retrieve the content of the API and store it in the variable data_source_content.

var data_source_content = data_source.getContentText();

// Next we parse the data and store the result in the variable data_source_result.

var data_source_result = JSON.parse(data_source_content);

// Since we want the data to display in descending order from End Date to Start Date we ae going to reverse the order of the result and store the data in the variable data_source_reverse_order

var data_source_reverse_order = data_source_result.data.values.reverse()

// The above function reverses the order of the values array. 

/* The next few steps we are going to start outputting the data in the respective positions on the Model worksheet. We are going to create a variable outer_looper to loop through the outer array.
That will allow us to get the line by line data. Next we are going to create a trade_looper to get the retrieve the trade volume data based on the index position in the inner array. 
The Date is the first in the array so the index position is 0 and since we have already retrieved the date in the callAsset_Price function we are going to ignore this data point. The index position for the trade volume data in the inner array is 1.*/

// creating the outer_looper

var outer_looper = 0;

// Looping through the outer array
 
for (outer_looper = 0; outer_looper < data_source_reverse_order.length; outer_looper++) {

// Next we are going to create variables  for the trade volume data point to get the respective values from the inner array.

// We are going to start with the trade volume, create a variable trade_looper.

var trade_looper = 1

// Next we are going to output the variable in the respect position in the spreadsheet and change the format from timestamp to date.

if (trade_looper === 1) get_model.getRange( outer_looper + 12 ,trade_looper+7).setValue(data_source_reverse_order[outer_looper][trade_looper]);


}

// That is the end of this function. 

}



function callAsset_Market_Cap() {
// This function retrieves the historical Market Capitalization data for an asset for a specified period.

// First retrieve the spreadsheet (google sheet) we want to work on. The name of the google sheet is the Crypto Assets Metrics.  

// To do that we first get the active spreadsheet 

var app = SpreadsheetApp;

// Next we get the active google sheet " Crypto Asset Metrics" and stores it in a variable get_active_spreadsheet.

var get_active_spreadsheet = app.getActiveSpreadsheet();

// get the worksheet we will be working on. The name of the worksheet is "Model". Hence we will get the Model worksheet and store it in the variable get_model

var get_model = get_active_spreadsheet.getSheetByName("Model")

// Next we are going to clear the previous data in the range we are going to update

/* The next line clears the data in the range we are working with. The purpose is that before we source the data we are going to clear any data already existing in those rows. 
This particular line clears the data in the Open, High, Low, Close sections of the Model worksheet */

get_model.getRange(12,10,1500,1).clearContent()

// Next we are going to work on importing the Asset's trade market capitalization data by calling/ pulling the data from Messari's "Get Asset Timeseries API".

// First we are going to pull the appropriate input's from the input section of the data set. 

/* The data we need inputted from the Model worksheet is the Asset's Ticker, Start Date and End Date. We are going to import this data and store it in their individual/ respective variables. 
We are going to use those inputs to form the Messari's API. That is they are going to be used to call the data from the appropriate API. We need to verify that the datatype of the inputs we retrieve are Strings
Hence we are going to confirm the data type. If they are not Strings we are going to convert the data to Strings. */

// First we will start by retreiving the Asset's Ticker input and store it in the variable get_ticker

var get_ticker = get_model.getRange("C5").getValue();

// Next use the Logger.log function we are going to log the data type of the Asset Ticker.

// Logger.log(typeof get_ticker)

// Next we are going to get the Start Date input and store it in the variable get_start

var get_start = get_model.getRange("D5").getValue();

// Next use the Logger.log function we are going to log the data type of the Start Date.

// Logger.log(typeof get_start)

/// Next we are going to get the End Date input and store it in the variable get_end

var get_end = get_model.getRange("E5").getValue();

// Next use the Logger.log function we are going to log the data type of the End Date.

// Logger.log(typeof get_end)

/* Next we are going to use the get_ticker, get_start and get_end variables to source the data from messari. We are going to store the pulled data in the variable data_source
Note we are using the mcap.out API to assess the market capitalization because it is the sum USD value of the current supply also referred to as network value or market capitalization.*/


var data_source = UrlFetchApp.fetch("https://data.messari.io/api/v1/assets/" + get_ticker +"/metrics/mcap.out/time-series?start=" + get_start + "&interval=1d&end=" + get_end);

// Next we are going to log the data source to check if the data we got was correct.

// Logger.log(" ")

// Logger.log(data_source)

// In the next two steps we are going to retrieve the content of the API then parse it into JSON which would allow us to work on the content of the API.

// First we retrieve the content of the API and store it in the variable data_source_content.

var data_source_content = data_source.getContentText();

// Next we parse the data and store the result in the variable data_source_result.

var data_source_result = JSON.parse(data_source_content);

// Since we want the data to display in descending order from End Date to Start Date we ae going to reverse the order of the result and store the data in the variable data_source_reverse_order

var data_source_reverse_order = data_source_result.data.values.reverse()

// The above function reverses the order of the values array. 

/* The next few steps we are going to start outputting the data in the respective positions on the Model worksheet. We are going to create a variable outer_looper to loop through the outer array.
That will allow us to get the line by line data. Next we are going to create a mcap_looper to get the retrieve the market capitalization data based on the index position in the inner array. 
The Date is the first in the array so the index position is 0 and since we have already retrieved the date in the callAsset_Price function we are going to ignore this data point. The index position for the market capitalization data in the inner array is 1.*/

// creating the outer_looper

var outer_looper = 0;

// Looping through the outer array
 
for (outer_looper = 0; outer_looper < data_source_reverse_order.length; outer_looper++) {

// Next we are going to create variables  for the market capitalization data point to get the respective values from the inner array.

// We are going to start with the market capitalization , create a variable mcap_looper.

var mcap_looper = 1

// Next we are going to output the variable in the respect position in the spreadsheet and change the format from timestamp to date.

if (mcap_looper === 1) get_model.getRange( outer_looper + 12 ,mcap_looper+9).setValue(data_source_reverse_order[outer_looper][mcap_looper]);


}

// That is the end of this function. 

}

// Here is a link to the google sheet: https://docs.google.com/spreadsheets/d/1iyL45xPOm9tZeX9E873-LgUjHtE2ZCYZdu4A55FnZwU/edit#gid=0
